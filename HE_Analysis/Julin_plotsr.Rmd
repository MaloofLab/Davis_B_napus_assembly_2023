---
title: "Julin_plotsr_plots"
author: "Julin Maloof"
date: "2022-11-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Plotting HE exchange (and coverage?) with [plotsr](https://github.com/schneebergerlab/plotsr)

```{r}
library(tidyverse)
library(GenomicRanges)
library(Biostrings)
library(reticulate)
```


# generate files

```{r}
if(!dir.exists("plotsr")) dir.create("plotsr")
```


## chr lengths

```{r}
# get the files and data
chrom.lengths <- tibble(file=dir("../Assemblies", pattern = "lengths", full.names = TRUE)) %>%
  mutate(lengths=map(file, read_tsv, show_col_types=FALSE, col_names=c("chrom", "length")),
         file=basename(file))

# make consistent chrom names
chrom.lengths <- chrom.lengths %>%
  mutate(lengths = map(lengths, function(x) {
    x %>% 
      mutate(chrom=str_replace(chrom, "^.*([AC][0-9]{1,2})$", "\\1"), #remove prefix
             chrom=str_replace(chrom, "C([1-9])", "C0\\1")) # pad C numbers if needed
  }))

#update file names to mactch plots requirement
chrom.lengths <- chrom.lengths %>%
  mutate(file=str_replace(file, "_chrom_lengths.txt", ".chrlen"))

# write the files
chrom.lengths %>% pwalk( ~ write_tsv(.y, file.path("plotsr", .x), col_names = FALSE))

#verify chrom names
chrom.lengths %>% unnest(lengths) %>%  pull(chrom) %>% unique()
```

## genome info

Need a separate `genomes.txt` file for each plot that we want to make
```{r}
genome.info <- tibble(`#file` = dir("plotsr", pattern="chrlen"),
                      name = str_remove(`#file`, "\\.chrlen"),
                      tag = "ft:cl")  %>%
  filter(! (name %in% c("Boleracea",
                        "Brapa",
                        "Darmor-Bzh_V4.1",
                        "pseudo_napus")
  )  )

for(g in str_subset(genome.info$name, "Ancestral|DaAe", negate = TRUE)) {
  positions <- match(c(g, "Ancestral", "DaAe"), genome.info$name)
  write_tsv(genome.info[positions,], 
            str_c("plotsr/",g,"_Anc_DaAe_genomes.txt")
  )
}
```

# synteny and rearrangement files:

This is almost the same code as from the HE_Comparison, but I need to not filter by HE.  (although note there is an option to only have HE if desired)

## Set up Ancestral chromosomes

```{r}
Anc_lengths <- read_tsv("../Assemblies/pseudo_napus_chrom_lengths.txt", col_names = c("chrom", "length")) %>%
  mutate(chrom=str_c("Anc-", chrom)) %>%
  mutate(grangeinput =str_c(chrom,":1-",length))

Anc_chroms <- GRanges(Anc_lengths$grangeinput)
seqlengths(Anc_chroms) <- Anc_lengths %>% pull(length) 


Br_chroms <- Anc_chroms[str_detect(seqnames(seqinfo(Anc_chroms)), "Anc-A")]
seqlevels(Br_chroms) <- str_subset(seqlevels(Br_chroms), "Anc-A") #drop unused levels

Bo_chroms <- Anc_chroms[str_detect(seqnames(seqinfo(Anc_chroms)), "Anc-C")]
seqlevels(Bo_chroms) <- str_subset(seqlevels(Bo_chroms), "Anc-C")
```

### Get the Br vs Bo Comparison

```{r}
colnames <- unlist(strsplit("ref.start ref.end q.start q.end ref.len q.len pct.id ref.name q.name", split=" "))

Br_vs_Bo <- read_lines("../HE_Analysis/Brapa_vs_Boleracea/Brapa_vs_Boleracea-1.show-coords.gz", skip=5)
system.time(Br_vs_Bo <- Br_vs_Bo %>% str_replace_all("\\||\\t", " ") %>%
              str_trim() %>%
              tibble(data=.) %>% 
              separate(data, into=colnames, sep=" +", convert=TRUE) 
) #system.time
```

Reformat chromosome names
```{r}
Br_vs_Bo <- Br_vs_Bo %>%
  mutate(ref.name=str_c("Anc-", ref.name),
         q.name=str_c("Anc-",q.name)) %>%
  rowwise() %>%
  mutate(q.start.new=min(q.start, q.end),
         q.end=max(q.start, q.end),
         q.start=q.start.new) %>%
  select(-q.start.new)

head(Br_vs_Bo)
```
Take a look:
```{r}
Br_vs_Bo %>% ggplot(aes(x=ref.len)) +
  geom_histogram() +
  scale_x_log10()

Br_vs_Bo %>% ggplot(aes(x=pct.id)) +
  geom_histogram()
```
Filter it

```{r}
Br_vs_Bo.filter <- Br_vs_Bo %>% filter(pct.id >= 85, ref.len>=500)
```

Make a Br_vs_Bo Granges that has both genomes on the left hand side.  These are "Trusted" regions where we "know" that there is a 1:1 correspondence between the two assemblies.
```{r}
Anc_trusted_gr <- c(with(Br_vs_Bo.filter,
                         GRanges(seqinfo=seqinfo(Anc_chroms),
                                 seqnames = ref.name,
                                 ranges = IRanges(start=ref.start, end=ref.end))),
                    with(Br_vs_Bo.filter,
                         GRanges(seqinfo=seqinfo(Anc_chroms),
                                 seqnames = q.name,
                                 ranges = IRanges(start=q.start, end=q.end))))

```

## Loop through assemblies

For each assembly we want to load the Nucmer file, filter based on HE, %ID, length, and whether it overlaps with a trusted ancestral region.

```{r}
comparisons <- tibble(directory=dir(pattern="_vs_Ancestral", include.dirs = TRUE),
                      assembly=str_remove(directory, "_vs_Ancestral"))
comparisons
```

```{r}
colnames <- unlist(strsplit("ref.start ref.end q.start q.end ref.len q.len pct.id ref.name q.name", split=" "))

get_links <- function(directory) { # function to read in and format nucmer comparison info
  links <- read_lines(file.path(directory,str_c(directory,"-1.show-coords.gz")), skip = 5)
  links <- links %>% str_replace_all("\\||\\t", " ") %>%
    str_trim() %>%
    tibble(data=.) %>% 
    separate(data, into=colnames, sep=" +", convert=TRUE) 
  
  #extract subgenome info and reformat chromosome names
  links <- links %>%
    mutate(
      ref.subg = str_replace(ref.name, ".*(A|C)[0-9]{1,2}$", "\\1"),
      q.subg =  str_replace(q.name, ".*(A|C)[0-9]{1,2}$", "\\1"),
      ref.name=str_replace(ref.name, "chr", "DaAe-"),
      q.name=str_c("Anc-",q.name)) %>%
    rowwise() %>%
    mutate(q.dir=ifelse(q.start > q.end, "-", "+"),
           q.start.new=min(q.start, q.end),
           q.end=max(q.start, q.end),
           q.start=q.start.new) %>%
    select(-q.start.new)
  
  return(links)
}

#Function to convert links to Genomics Ranges
links_to_gr <- function(links) { 
  linksgr <- with(links, GRanges(seqinfo=seqinfo(Anc_chroms),
                                 seqnames = q.name, #query is ancestral, 
                                 ranges = IRanges(start=q.start, end=q.end),
                                 strand=q.dir,
                                 to.GR = GRanges(seqnames = ref.name,
                                                 ranges = IRanges(start=ref.start,
                                                                  end=ref.end)),
                                 pct.id = pct.id,
                                 ref.len = ref.len
  ))
  linksgr <- subsetByOverlaps(linksgr, Anc_trusted_gr, ignore.strand=TRUE)
  linksgr
}
```

```{r}
system.time(
  comparisons <- comparisons %>% 
    mutate(links=map(directory, get_links))
)
```

```{r}
comparisons <- comparisons %>%
  mutate(linksgr = map(links, links_to_gr))
```

## Format for plotsr

These columns are needed:
* Reference chromosome name
* Reference start position
* Reference end position
* Query chromosome name
* Query start position
* Query end position
* Annotation type

Also, plotsr is zero based and the files are 1 based, so need to subtract 1.

for each pairwise comparison need to create a BEDPE comparison file.  In these files, "reference" would be the upper genome in the plot and "query" will be the lower.  So DaAe will be handled separately from the rest.  For DaAe, DaAe is the query, and Ancestral is the reference  For all others, Ancestral is the query and the B. napus is the reference.

```{r}
plotsr <- comparisons %>%
  mutate(plotsr.out = map(linksgr, as.data.frame))%>%
  select(-links, -linksgr)

head(plotsr$plotsr.out[[2]])
```
### DaAe:

```{r}
DaAe.plotsr <- plotsr %>%
  filter(assembly=="DaAe") %>%
  pull(plotsr.out) %>%
  magrittr::extract2(1)

DaAe.plotsr <- DaAe.plotsr %>%
  select(r.chrom=seqnames,
         r.start=start,
         r.end=end,
         strand,
         q.chrom=to.GR.seqnames,
         q.start=to.GR.start,
         q.end=to.GR.end,
         pct.id,
         ref.len)

DaAe.plotsr <- DaAe.plotsr %>%
  filter(pct.id > 90, ref.len > 100) %>%
  mutate(r.start = r.start - 1,
         r.end = r.end -1,
         q.start = q.start -1,
         q.end = q.end -1,
         q.chrom=str_remove(q.chrom, "DaAe-"),
         r.chrom=str_remove(r.chrom, "Anc-"),
         r.chrom=str_replace(r.chrom, "C([1-9])", "C0\\1"),
         q.start.new=ifelse(strand=="-", q.end, q.start),
         q.end=ifelse(strand=="-", q.start, q.end),
         q.start=q.start.new,
         ann=ifelse(str_sub(r.chrom, 1, 3) != str_sub(q.chrom, 1,3),
                    str_c("TRANS-", r.chrom), #add the ancestral chrom # for plotting. 
                    "SYN")
  ) %>%
  select(-pct.id, -ref.len, -strand, -q.start.new) %>%
  arrange(r.chrom, r.start)


head(DaAe.plotsr)

# write it
write_tsv(DaAe.plotsr, "plotsr/Ancestral_DaAe.bedpe", col_names = FALSE)
```
```{r}
any(DaAe.plotsr$q.start > DaAe.plotsr$q.end)
```

### everybody else

```{r}
others.plotsr <- plotsr %>%
  filter(assembly!="DaAe")

others.plotsr <- others.plotsr %>%
  mutate(plotsr.out = map(plotsr.out, function(x) {
    x %>% 
      select(r.chrom=to.GR.seqnames,
             r.start=to.GR.start,
             r.end=to.GR.end,
             strand,
             q.chrom=seqnames,
             q.start=start,
             q.end=end,
             pct.id,
             ref.len) %>%
      
      filter(pct.id > 90, ref.len > 100) %>%
      
      mutate(r.start = r.start - 1,
             r.end = r.end -1,
             q.start = q.start -1,
             q.end = q.end -1,
             q.chrom=str_remove(q.chrom, "Anc-"),
             r.chrom=str_replace(r.chrom, "C([1-9])", "C0\\1"),
             r.chrom=str_replace(r.chrom, "^.*([AC][0-9]{1,2})$", "\\1"),
             q.chrom=str_replace(q.chrom, "C([1-9])", "C0\\1"),
             q.start.new=ifelse(strand=="-", q.end, q.start),
             q.end=ifelse(strand=="-", q.start, q.end),
             q.start=q.start.new,
             ann=ifelse(str_sub(r.chrom, 1, 3) != str_sub(q.chrom, 1, 3),
                        str_c("TRANS-", q.chrom), 
                        "SYN")
      ) %>%
      select(-pct.id, -ref.len, -q.start.new, -strand) %>%
      arrange(r.chrom, r.start)
    
  }
  )
  )

others.plotsr
others.plotsr$plotsr.out[[9]]
```

```{r}
others.plotsr %>%
  select(-directory) %>%
  pwalk(~ write_tsv(.y, file.path("plotsr", str_c(.x, "_Ancestral.bedpe")), col_names = FALSE))
```

```{r}
any(others.plotsr$plotsr.out[[9]]$r.start > others.plotsr$plotsr.out[[9]]$r.end)
any(others.plotsr$plotsr.out[[9]]$q.start > others.plotsr$plotsr.out[[9]]$q.end)


```

```{r}
others.plotsr$plotsr.out[[9]] %>%
  group_by(r.chrom) %>%
  summarize(maxrstart=max(r.start), maxrend=max(r.end))

others.plotsr$plotsr.out[[9]] %>%
  group_by(q.chrom) %>%
  summarize(maxqstart=max(q.start), maxqend=max(q.end))
```

## Special Cases

For DaAe Coverage on itself, we need to plot DaAe_Anc
```{r}
#genome file for DaAe_Anc:
positions <- match(c("DaAe", "Ancestral"), genome.info$name)
  write_tsv(genome.info[positions,], "plotsr/DaAe_Anc_genomes.txt")

#reverse query and reference for DaAe:
DaAe.plotsr %>%
  select(r.chrom = q.chrom, 
         r.start=q.start, 
         r.end=q.end, 
         q.chrom=r.chrom, 
         q.start=r.start, 
         q.end=r.end,
         ann) %>%
  arrange(r.chrom, r.start) %>%
write_tsv("plotsr/DaAe_Ancestral.bedpe", col_names = FALSE)
```

For DaAe Coverage on Ancestral, we need to plot Anc_DaAe

```{r}
#genome file for DaAe_Anc:
positions <- match(c("Ancestral", "DaAe"), genome.info$name)
  write_tsv(genome.info[positions,], "plotsr/Anc_DaAe_genomes.txt")
```


# Add coverages

## Create coverage bedgraph files and tracksinfo files.
```{r}
load("Julin_Coverages_and_Positions_median.RData")
Clustered_All <- Clustered_All %>%   mutate(Chromosome=str_remove(Chromosome, "chr"),
                                            Assembly=str_replace(Assembly, "Pseudo_napus", "Ancestral"))
unique(Clustered_All$Assembly)
unique(Clustered_All$Chromosome)
```

```{r}
for(a in unique(Clustered_All$Assembly)) {
  Clustered_All %>% filter(Assembly==a, !is.na(Consensus)) %>%
    select(Chromosome, Start, End, Consensus) %>%
    write_tsv(str_c("plotsr/", a, "_cov.bedgraph"), col_names = FALSE)
  
  tibble(`#file`=str_c(a, "_cov.bedgraph"), 
         name=str_c("DaAe_coverage_on_", a),
         tags="ft:bedgraph;bw:10000") %>%
    write_tsv(str_c("plotsr/", a, "_tracks.txt"))
}
```

# plot it

Move modified func.py into place.  Change the path below to match your system.
```{r, eval=FALSE}
if(!(file.exists("/opt/homebrew/Caskroom/miniconda/base/envs/plotsr/lib/python3.10/site-packages/plotsr/func.py.bak"))) 
  file.copy("/opt/homebrew/Caskroom/miniconda/base/envs/plotsr/lib/python3.10/site-packages/plotsr/func.py", "/opt/homebrew/Caskroom/miniconda/base/envs/plotsr/lib/python3.10/site-packages/plotsr/func.py.bak")

file.copy("plotsr/modified_func.py", "/opt/homebrew/Caskroom/miniconda/base/envs/plotsr/lib/python3.10/site-packages/plotsr/func.py", overwrite = TRUE)

#file.copy("plotsr/jm_func.py", "/opt/homebrew/Caskroom/miniconda/base/envs/plotsr/lib/python3.10/site-packages/plotsr/func.py", overwrite = TRUE)
```


plot those with coverage tracks
```{bash}
cd plotsr

mkdir plots

source ~/.bash_profile

conda activate plotsr

params_cov="--itx --cfg base.cfg -H 4 -W 12 -S 0.5 "

# plot the comparisons where we have coverage:
glist="Darmor-Bzh_V10 ZS11"
for g in ${glist}
do
echo $g
plotsr --itx \
--bp ${g}_Ancestral.bedpe \
--bp Ancestral_DaAe.bedpe \
--genomes ${g}_Anc_DaAe_genomes.txt \
--tracks ${g}_tracks.txt \
-o plots/${g}_Anc_DaAe_cov.pdf \
${params_cov}
done
```

plot special cases
```{bash}
cd plotsr

source ~/.bash_profile

conda activate plotsr

params_cov="--itx --cfg base.cfg -H 4 -W 12 -S 0.5 "

plotsr --itx \
--bp DaAe_Ancestral.bedpe \
--genomes DaAe_Anc_genomes.txt \
--tracks DaAe_tracks.txt \
-o plots/DaAe_Anc_cov.pdf \
${params_cov}

plotsr --itx \
--bp Ancestral_DaAe.bedpe \
--genomes Anc_DaAe_genomes.txt \
--tracks Ancestral_tracks.txt \
-o plots/Anc_DaAe_cov.pdf \
${params_cov}

```

plot those without coverage tracks
```{bash}
cd plotsr

mkdir plots

source ~/.bash_profile

conda activate plotsr

params_cov="--itx --cfg base.cfg -H 4 -W 12 -S 0.75 "

# plot the comparisons where we do not have coverage:
glist="GangfanF73 No2127 QuintaA Shengli3 Tapidor Westar Zheyou73"
for g in ${glist}
do
echo $g
plotsr --itx \
--bp ${g}_Ancestral.bedpe \
--bp Ancestral_DaAe.bedpe \
--genomes ${g}_Anc_DaAe_genomes.txt \
-o plots/${g}_Anc_DaAe.pdf \
${params_cov}
done
```

plot specific regions:

